name: multi_agent_workflow
description: "Multi-agent workflow with worktree preparation and cleanup hooks"

steps:
  - id: analyze_requirements
    role: Requirements Analyst
    prompt: |
      Analyze the following requirements and break them down into implementable tasks:
      {requirements}

      Return a JSON structure with:
      {
        "tasks": [
          {
            "id": "task-1",
            "title": "...",
            "description": "...",
            "agent_type": "rust-service-layer-specialist",
            "estimated_effort": "small|medium|large"
          }
        ],
        "dependencies": [
          {"task": "task-2", "depends_on": ["task-1"]}
        ]
      }
    expected_output:
      type: json
      schema:
        type: object
        properties:
          tasks:
            type: array
            items:
              type: object
              properties:
                id:
                  type: string
                title:
                  type: string
                description:
                  type: string
                agent_type:
                  type: string
                estimated_effort:
                  type: string
                  enum:
                    - small
                    - medium
                    - large
              required:
                - id
                - title
                - description
                - agent_type
          dependencies:
            type: array
        required:
          - tasks
    next: implement_first_task
    timeout_secs: 120

  - id: implement_first_task
    role: Implementation Specialist
    prompt: |
      Implement the first task from the analysis:
      {tasks}

      Focus on:
      1. Writing clean, well-documented code
      2. Following project conventions
      3. Including appropriate error handling
      4. Adding unit tests

      Return implementation details in JSON:
      {
        "files_created": ["path/to/file1.rs", "path/to/file2.rs"],
        "files_modified": ["path/to/existing.rs"],
        "tests_added": 5,
        "summary": "Brief description of what was implemented"
      }
    expected_output:
      type: json
      schema:
        type: object
        properties:
          files_created:
            type: array
            items:
              type: string
          files_modified:
            type: array
            items:
              type: string
          tests_added:
            type: integer
            minimum: 0
          summary:
            type: string
        required:
          - files_created
          - files_modified
          - tests_added
          - summary
    pre_hooks:
      # Prepare a worktree for this implementation step
      - type: run_script
        script_path: scripts/prepare_worktree.sh
        args:
          - "{task_id}"
          - "implementation"
    post_hooks:
      # Run tests after implementation
      - type: run_script
        script_path: scripts/run_tests.sh
        args:
          - "{task_id}"
      # Log completion
      - type: log_message
        level: info
        message: "Completed implementation for task {task_id}"
    next: review_implementation
    timeout_secs: 600

  - id: review_implementation
    role: Code Reviewer
    prompt: |
      Review the following implementation:
      {previous_output}

      Evaluate:
      1. Code quality and adherence to best practices
      2. Test coverage
      3. Documentation completeness
      4. Error handling
      5. Performance considerations

      Return review in JSON format:
      {
        "overall_rating": 1-10,
        "issues": [
          {
            "severity": "critical|major|minor|suggestion",
            "file": "path/to/file.rs",
            "line": 42,
            "description": "...",
            "suggestion": "..."
          }
        ],
        "approved": true/false,
        "comments": "Overall assessment..."
      }
    expected_output:
      type: json
      schema:
        type: object
        properties:
          overall_rating:
            type: integer
            minimum: 1
            maximum: 10
          issues:
            type: array
          approved:
            type: boolean
          comments:
            type: string
        required:
          - overall_rating
          - issues
          - approved
    post_hooks:
      # Create a tag if approved
      - type: run_script
        script_path: scripts/conditional_tag.sh
        args:
          - "{task_id}"
          - "{approved}"
    next: merge_if_approved
    timeout_secs: 300

  - id: merge_if_approved
    role: Merge Coordinator
    prompt: |
      Based on the review results:
      {previous_output}

      Determine the next steps:
      - If approved: merge to feature branch
      - If not approved: list required changes

      Return in JSON:
      {
        "action": "merge|revise",
        "target_branch": "feature/xxx",
        "required_changes": ["change1", "change2"] // empty if approved
      }
    expected_output:
      type: json
      schema:
        type: object
        properties:
          action:
            type: string
            enum:
              - merge
              - revise
          target_branch:
            type: string
          required_changes:
            type: array
        required:
          - action
    pre_hooks:
      # Ensure all tests pass before merging
      - type: run_script
        script_path: scripts/verify_tests.sh
        args:
          - "{task_id}"
    post_hooks:
      # Merge the branch if approved
      - type: merge_branch
        source: "task/{task_id}"
        target: "{target_branch}"
        strategy: auto
      # Clean up the worktree
      - type: delete_branch
        branch: "task/{task_id}"
        cleanup_worktree: true
      # Notify about completion
      - type: log_message
        level: info
        message: "Task {task_id} completed and merged successfully"
    timeout_secs: 180

validation_rules:
  - step_id: analyze_requirements
    rule_type: json_schema
    error_message: "Requirements analysis must include tasks array"

  - step_id: implement_first_task
    rule_type: json_schema
    error_message: "Implementation must specify files and test count"

  - step_id: review_implementation
    rule_type: json_schema
    error_message: "Review must include rating and approval status"
